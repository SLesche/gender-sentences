<!DOCTYPE html>
<html>
  <head>
    <title>Picture Identification Task</title>
    <meta charset="UTF-8">
    <script src="jspsych/dist/jspsych.js"></script>
    <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/dist/plugin-image-keyboard-response.js"></script>
    <script src="jspsych/dist/plugin-html-button-response.js"></script>
    <script src="jspsych/dist/plugin-preload.js"></script>
    <script src="jspsych/dist/plugin-instructions.js"></script>
    <script src="jspsych/dist/plugin-survey.js"></script>
    <script src="jspsych/dist/plugin-survey-likert.js"></script>
    <script src="jspsych/dist/plugin-survey-text.js"></script>
    <link href="jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="css/stim_styles.css">
    <script src="scripts/setup.js"></script>
    <script src="scripts/helper_function.js"></script>
    <script src="scripts/instructions.js"></script>
    <script src="scripts/task.js"></script>
    <script src="scripts/debriefing.js"></script>
    <script src = "https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  </head>
  <body></body>
  <script>
    // Function to set up the experiment after the CSV is loaded
    function setupExperiment(stimulus_list) {   
      const selected_trials = jsPsych.randomization.shuffle(stimulus_list); // Select trials for the experiment
      console.log("Setting up experiment with stimulus list: ", selected_trials);   
      var trial_num = 0;
      var block_num = 0;
      var repeat_practice_now = 1;

      console.log(stimulus_list[trial_num])
      
      // Read all files in the stimuli/imgs folder (run in Terminal)
      //       Get-ChildItem -Recurse -Path .\stimuli\imgs\ -Include *.png, *.jpg, *.jpeg, *.gif | 
      // ForEach-Object { $_.FullName.Replace($pwd.Path + '\', '') } | 
      // ForEach-Object { "'$($_.Replace('\', '/'))'," } > stimuli/imgs.txt
      
      var preload = {
        type: jsPsychPreload,
        images: possible_images,
        message: function() {
          return jsPsych.randomization.sampleWithReplacement(loading_messages, 1)
        }
      }

      var sentence_picture_procedure = {
        timeline: [
          {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<p class = "normal-text">+</p>',
            choices: "NO_KEYS", // No keys allowed during fixation
            trial_duration: fixation_dur, // Duration of fixation in milliseconds
            response_ends_trial: false,
          },
          {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function(){
              return `<p class = "sentence-stim"> ${jsPsych.timelineVariable('sentence')} </p>`
            },
            choices: "NO_KEYS",
            trial_duration: sentence_duration,
          },
          {
            type: jsPsychHtmlKeyboardResponse,
            stimulus_width: 800,
            maintain_aspect_ratio: true,
            stimulus: function() {
              const picture_path = 'stimuli/imgs/' + jsPsych.timelineVariable('picture');
              return `<div class="picture-stim"><img src="${picture_path}" class="stimulus-image"></div>`;
            },
            prompt: '<p class = "normal-text">Ist das Bild passend zur Aussage? <br> Ja = "D" Nein "L"</p>',
            choices: possible_response_keys,
            trial_duration: picture_duration,
            response_ends_trial: true,
            post_trial_gap: rsi_duration,
            on_finish: function(data) {
                // Record accuracy and congruency
                data.condition = jsPsych.timelineVariable('condition');
            }
          }
        ],
        timeline_variables: stimulus_list,
        randomize_order: true
      }

      experiment_timeline = [instructions, sentence_picture_procedure];
      jsPsych.run(experiment_timeline);
    }

    // Initialize the experiment after the CSV is loaded
    Papa.parse('https://raw.githubusercontent.com/SLesche/gender-sentences/main/stimuli/available_stimuli.csv', {
      header: true,
      download: true,
      complete: function(results) {
        let available_stimuli = results.data; // Assign the parsed data to available_stimuli

        jsPsych.randomization.setSeed(subject_id); // Set seed for reproducibility
        console.log(subject_id, available_stimuli);
        setupExperiment(available_stimuli);  // Setup and start the experiment once the data is available
      }
    });
  </script>
</html>
