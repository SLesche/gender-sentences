<!DOCTYPE html>
<html>
  <head>
    <title>Picture Identification Task</title>
    <meta charset="UTF-8">
    <script src="jspsych/dist/jspsych.js"></script>
    <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/dist/plugin-image-keyboard-response.js"></script>
    <script src="jspsych/dist/plugin-html-button-response.js"></script>
    <script src="jspsych/dist/plugin-preload.js"></script>
    <script src="jspsych/dist/plugin-instructions.js"></script>
    <script src="jspsych/dist/plugin-survey.js"></script>
    <script src="jspsych/dist/plugin-survey-likert.js"></script>
    <script src="jspsych/dist/plugin-survey-text.js"></script>
    <link href="jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="css/stim_styles.css">
    <script src="scripts/setup.js"></script>
    <script src="scripts/helper_function.js"></script>
    <script src="scripts/instructions.js"></script>
    <script src="scripts/task.js"></script>
    <script src="scripts/debriefing.js"></script>
    <script src = "https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  </head>
  <body></body>
  <script>
    // Function to set up the experiment after the CSV is loaded
    function setupExperiment(stimulus_list) {   
      console.log("Setting up experiment with stimulus list: ", stimulus_list);   
      var trial_num = 0;
      var block_num = 0;
      var repeat_practice_now = 1;

      console.log(stimulus_list[trial_num])
      
      // Read all files in the stimuli/imgs folder (run in Terminal)
      //       Get-ChildItem -Recurse -Path .\stimuli\imgs\ -Include *.png, *.jpg, *.jpeg, *.gif | 
      // ForEach-Object { $_.FullName.Replace($pwd.Path + '\', '') } | 
      // ForEach-Object { "'$($_.Replace('\', '/'))'," }

      const possible_images = [
        'stimuli/imgs/astronauten_seilspringen_brunnen_frauen.jpg',
        'stimuli/imgs/astronauten_seilspringen_brunnen_gemischt.jpg',
        'stimuli/imgs/astronauten_seilspringen_brunnen_männer.jpg',
        'stimuli/imgs/FS_kellner_liegen_supermarkt_frauen.jpg',
        'stimuli/imgs/FS_kellner_liegen_supermarkt_gemischt.jpg',
        'stimuli/imgs/FS_kellner_liegen_supermarkt_männer.jpg',
        'stimuli/imgs/FS_maler_liegen_flugzeug_frauen.jpg',
        'stimuli/imgs/FS_maler_liegen_flugzeug_gemischt.jpg',
        'stimuli/imgs/FS_maler_liegen_flugzeug_männer.jpg',
        'stimuli/imgs/FS_schwimmer_kaffeetrinken_vulkan_frauen.jpg',
        'stimuli/imgs/FS_schwimmer_kaffeetrinken_vulkan_gemischt.jpg',
        'stimuli/imgs/FS_schwimmer_kaffeetrinken_vulkan_männer.jpg',
        'stimuli/imgs/kellner_laufen_flugzeug_frauen.jpg',
        'stimuli/imgs/kellner_laufen_flugzeug_gemischt.jpg',
        'stimuli/imgs/kellner_laufen_flugzeug_männer.jpg',
        'stimuli/imgs/sportler_laufen_brunnen_frauen.jpg',
        'stimuli/imgs/sportler_laufen_brunnen_gemischt.jpg',
        'stimuli/imgs/sportler_laufen_brunnen_männer.jpg',
      ];
      
      var preload = {
        type: jsPsychPreload,
        images: possible_images,
        message: function() {
          return jsPsych.randomization.sampleWithReplacement(loading_messages, 1)
        }
      }

      var sentence_picture_procedure = {
        timeline: [
          {
              type: jsPsychHtmlKeyboardResponse,
              stimulus: '<p class = "normal-text">+</p>',
              choices: "NO_KEYS", // No keys allowed during fixation
              trial_duration: fixation_dur, // Duration of fixation in milliseconds
              response_ends_trial: false,
              data: {type: 'fixation', block_num: block_num},
          },
          {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: jsPsych.timelineVariable('sentence'),
          choices: "NO_KEYS",
          trial_duration: sentence_duration,
          },
          {
            type: jsPsychImageKeyboardResponse,
            stimulus: function() {return'stimuli/imgs/' + jsPsych.timelineVariable('picture')},
            choices: possible_response_keys,
            trial_duration: picture_duration,
            response_ends_trial: true,
            post_trial_gap: rsi_duration,
            on_finish: function(data) {
                // Record accuracy and congruency
                data.condition = jsPsych.timelineVariable('condition');
            }
          }
        ],
        timeline_variables: stimulus_list,
        randomize_order: true
      }

      experiment_timeline = [instructions, sentence_picture_procedure];
      jsPsych.run(experiment_timeline);
    }

    // Initialize the experiment after the CSV is loaded
    Papa.parse('https://raw.githubusercontent.com/SLesche/gender-sentences/main/stimuli/available_stimuli.csv', {
      header: true,
      download: true,
      complete: function(results) {
        let available_stimuli = results.data; // Assign the parsed data to available_stimuli

        jsPsych.randomization.setSeed(subject_id); // Set seed for reproducibility
        console.log(subject_id, available_stimuli);
        setupExperiment(available_stimuli);  // Setup and start the experiment once the data is available
      }
    });
  </script>
</html>
